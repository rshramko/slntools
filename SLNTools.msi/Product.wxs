<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:netfx="http://schemas.microsoft.com/wix/NetFxExtension">

  <!--The following variables must be modified for each release. A new GUID should be generated each time.-->
  <?define ProductVersion=1.1.3.1 ?>
  <?define ProductCode=6F93C7C0-4036-4739-907B-68AFFB449B44?>

  <!--The following variable should NEVER be modified. -->
  <?define UpgradeCode=9A791ED6-C6EA-4234-84E2-9A08122BBC61 ?>

  <Product Id="$(var.ProductCode)"
           Name="SLN File Tools"
           Language="1033"
           Version="$(var.ProductVersion)"
           Manufacturer="Roman Shramko"
           UpgradeCode="$(var.UpgradeCode)">
        <Package InstallerVersion="200" Compressed="yes" />

        <Media Id="1" Cabinet="media.cab" EmbedCab="yes" />

        <Directory Id="TARGETDIR" Name="SourceDir">
            <Directory Id="ProgramFilesFolder">
                <Directory Id="INSTALLLOCATION" Name="SLN File Tools" />
            </Directory>
            <Directory Id="ProgramMenuFolder">
                <Directory Id="ApplicationProgramsFolder" Name="SLN File Tools"/>
            </Directory>
        </Directory>

    <DirectoryRef Id="INSTALLLOCATION">
      <Component Id="Component_SLNTools.exe" Guid="*">
        <File Id="Component_SLNTools.exe" Source="$(var.SLNTools.exe.TargetDir)\SLNTools.exe" KeyPath="yes" />

        <Environment 
                  Id="Environment" 
                  Name="PATH" 
                  Action="set"
                  Part="last" 
                  System="yes" 
                  Value="[INSTALLLOCATION]" /> 

        <ProgId Id="SLNTools.slnfilter"
                Description="Filter for Microsoft Visual Studio Solution"
                IconIndex="0"
                Advertise="yes">
          <Extension Id="slnfilter" Advertise="yes">
            <Verb Id=".UpdateOpen" Command="&amp;Update and Open Filtered Solution" Argument="OpenFilterFile &quot;%1&quot;" Sequence="1" />
            <Verb Id="Edit Filter" Command="&amp;Edit Filter" Argument="EditFilterFile &quot;%1&quot;" Sequence="2" />
            <Verb Id="createsln" Command="&amp;Create Filtered Solution Only" Argument="OpenFilterFile &quot;%1&quot; -CreateOnly -p" Sequence="3" />
          </Extension>
        </ProgId>
      </Component>
      <Component Id="Component_AddShellCommandForSLNFile" Guid="*">
        <RegistryValue Root="HKCR" Key="VisualStudio.Launcher.sln\Shell\Create Filter\Command" Value="&quot;[INSTALLLOCATION]\SLNTools.exe&quot; CreateFilterFileFromSolution &quot;%1&quot;" Type="string" KeyPath="yes" />
      </Component>

      <Component Id="Component_CWDev.SLNTools.Core.dll" Guid="*">
        <File Source="$(var.CWDev.SLNTools.Core.dll.TargetDir)\CWDev.SLNTools.Core.dll" />
      </Component>
      <Component Id="Component_CWDev.SLNTools.UIKit.dll" Guid="*">
        <File Source="$(var.CWDev.SLNTools.UIKit.dll.TargetDir)\CWDev.SLNTools.UIKit.dll" />
      </Component>
    </DirectoryRef>
    <DirectoryRef Id="ApplicationProgramsFolder">
        <Component Id="ApplicationShortcut" Guid="*">
            <Shortcut Id="ApplicationStartMenuShortcut" 
                      Name="SLN File Tools"
                      Description="Tools for managing a SLN file"
                      Target="[#Component_SLNTools.exe]"
                      WorkingDirectory="INSTALLLOCATION"
                      />
            <RemoveFolder Id="CleanUpShortCut" Directory="ApplicationProgramsFolder" On="uninstall"/>
            <RegistryValue Root="HKCU" Key="Software\Microsoft\SLNTools" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
        </Component>
    </DirectoryRef>

    <Feature Id="ProductFeature" Title="Application" Level="1">
      <ComponentRef Id="Component_SLNTools.exe" />
      <ComponentRef Id="Component_CWDev.SLNTools.Core.dll" />
      <ComponentRef Id="Component_CWDev.SLNTools.UIKit.dll" />
      <ComponentRef Id="Component_AddShellCommandForSLNFile" />
      <ComponentRef Id="ApplicationShortcut" />
    </Feature>

    <!-- Validation : .Net framework installed or not. ====================================================-->

    <PropertyRef Id="NETFRAMEWORK45"/>
    <Condition Message="This application requires .NET Framework 4.5. Please install the .NET Framework then run this installer again.">
      <![CDATA[Installed OR NETFRAMEWORK45]]>
    </Condition>

    <MajorUpgrade AllowSameVersionUpgrades="yes" 
                  DowngradeErrorMessage="A newer version of [ProductName] is already installed. If you are sure you want to downgrade, remove the existing installation via Programs and Features." />

    <!-- Execute Sequence tweaking ========================================================================-->

    <Property Id="ALLUSERS"><![CDATA[1]]></Property>

    <!-- UI configuration =================================================================================-->

    <WixVariable Id="WixUILicenseRtf" Value="$(var.ProjectDir)\License.rtf" />
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLLOCATION" />
    <UIRef Id="WixUI_InstallDir" />
    <UIRef Id="WixUI_ErrorProgressText" />
  </Product>
</Wix>
